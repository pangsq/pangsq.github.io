<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Kubernetes Controller —— Controller Manager入口分析"><meta name="keywords" content="Kubernetes,Controller,Golang,Entry"><meta name="author" content="锋寒"><meta name="copyright" content="锋寒"><title>Kubernetes Controller —— Controller Manager入口分析 | 锋寒的博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#cmd-kube-controller-manager-controller-manager-go"><span class="toc-number">1.</span> <span class="toc-text">cmd&#x2F;kube-controller-manager&#x2F;controller-manager.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmd-kube-contoller-manager-app"><span class="toc-number">2.</span> <span class="toc-text">cmd&#x2F;kube-contoller-manager&#x2F;app&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NewContollerManagerCommand-，在controllermanager-go中"><span class="toc-number">2.1.</span> <span class="toc-text">NewContollerManagerCommand()，在controllermanager.go中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NewKubeControllerManagerOptions-在options-options-go中"><span class="toc-number">2.2.</span> <span class="toc-text">NewKubeControllerManagerOptions(),在options&#x2F;options.go中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Run-c-config-CompletedConfig-stopCh-lt-chan-struct-回到controllermanager-go"><span class="toc-number">2.3.</span> <span class="toc-text">Run(c *config.CompletedConfig, stopCh &lt;-chan struct{}),回到controllermanager.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StartControllers-在controolermanager-go中"><span class="toc-number">2.4.</span> <span class="toc-text">StartControllers,在controolermanager.go中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NewControllerInitializers-在controllermanager-go中"><span class="toc-number">2.5.</span> <span class="toc-text">NewControllerInitializers,在controllermanager.go中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#startNamespaceController-在core-go中"><span class="toc-number">2.6.</span> <span class="toc-text">startNamespaceController,在core.go中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参见client-go的例子"><span class="toc-number">2.7.</span> <span class="toc-text">参见client-go的例子</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">锋寒</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">9</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">锋寒的博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Kubernetes Controller —— Controller Manager入口分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-02</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kubernetes/">Kubernetes</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kubernetes/Controller/">Controller</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>branch: release-v1.18</p>
<p>commit: ff809a5d953ba778270ce8790b21d394821e1e28</p>
<h2 id="cmd-kube-controller-manager-controller-manager-go"><a href="#cmd-kube-controller-manager-controller-manager-go" class="headerlink" title="cmd/kube-controller-manager/controller-manager.go"></a><code>cmd/kube-controller-manager/controller-manager.go</code></h2><p>一个非常简洁标准的命令模样的入口</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line">	command := app.NewControllerManagerCommand()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> once we switch everything over to Cobra commands, we can go back to calling</span></span><br><span class="line">	<span class="comment">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the</span></span><br><span class="line">	<span class="comment">// normalize func and add the go flag set by hand.</span></span><br><span class="line">	<span class="comment">// utilflag.InitFlags()</span></span><br><span class="line">	logs.InitLogs()</span><br><span class="line">	<span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体实现逻辑明显在<code>NewControllerManagerCommand()</code>中</p>
<h2 id="cmd-kube-contoller-manager-app"><a href="#cmd-kube-contoller-manager-app" class="headerlink" title="cmd/kube-contoller-manager/app/"></a><code>cmd/kube-contoller-manager/app/</code></h2><h3 id="NewContollerManagerCommand-，在controllermanager-go中"><a href="#NewContollerManagerCommand-，在controllermanager-go中" class="headerlink" title="NewContollerManagerCommand()，在controllermanager.go中"></a>NewContollerManagerCommand()，在controllermanager.go中</h3><ol>
<li>构造ControllerManager命令；初始化配置</li>
<li>接下来运行 Run(c.Complete(), wait.NeverStop)  // 见 2.3</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewControllerManagerCommand creates a *cobra.Command object with default parameters</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewControllerManagerCommand</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	s, err := options.NewKubeControllerManagerOptions() <span class="comment">// 详情见2.2</span></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	cmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use: <span class="string">"kube-controller-manager"</span>,</span><br><span class="line">		Long: ...</span><br><span class="line">		Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">			...</span><br><span class="line"></span><br><span class="line">			c, err := s.Config(KnownControllers(), <span class="comment">// 所有支持的controllers名：sets.StringKeySet(NewControllerInitializers(IncludeCloudLoops)) </span></span><br><span class="line">			  ControllersDisabledByDefault.List()) <span class="comment">// 缺省被关闭的控制器，现在有"bootstrapsigner", "tokencleaner"</span></span><br><span class="line">			  <span class="comment">// 此处方法内部只有一个Validate(allContollers, disabledByDefaultControllers)用到了这两入参</span></span><br><span class="line">			  <span class="comment">// 注意到Run作为一个函数还没有到调用的时刻，cmd带哪些flags还得依赖从 `fs := cmd.Flags`开始的代码</span></span><br><span class="line">			...</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> err := Run(c.Complete(), wait.NeverStop); err != <span class="literal">nil</span> &#123; <span class="comment">// 核心入口</span></span><br><span class="line">				fmt.Fprintf(os.Stderr, <span class="string">"%v\n"</span>, err)</span><br><span class="line">				os.Exit(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fs := cmd.Flags()</span><br><span class="line">	namedFlagSets := s.Flags(KnownControllers(), ControllersDisabledByDefault.List()) </span><br><span class="line">	<span class="comment">// 给命令行组装flags，传入这俩参数是为了描述controllers这个配置项的时候提示总共有哪些controller以及哪些是默认禁用的</span></span><br><span class="line">	<span class="comment">// controllers默认是"*" 表示启用所有默认开启的controllers，如果配置"foo"表示开启foo，"-foo"表示关闭foo，以,分隔</span></span><br><span class="line">	... <span class="comment">// 其他一些初始化cmd</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NewKubeControllerManagerOptions-在options-options-go中"><a href="#NewKubeControllerManagerOptions-在options-options-go中" class="headerlink" title="NewKubeControllerManagerOptions(),在options/options.go中"></a>NewKubeControllerManagerOptions(),在options/options.go中</h3><ol>
<li>创建一份kubeControllerManager的默认配置；追溯其源头可以到<code>pkg/controller/apis/config/v1alpha1/defaults.go</code>中的SetDefaults_KubeControllerManagerConfiguration 查看各个缺省值</li>
<li>此处展开可以了解一些controllerManager中有哪些配置项以及其可能的默认配置</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewKubeControllerManagerOptions creates a new KubeControllerManagerOptions with a default config.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewKubeControllerManagerOptions</span><span class="params">()</span> <span class="params">(*KubeControllerManagerOptions, error)</span></span> &#123;</span><br><span class="line">	componentConfig, err := NewDefaultComponentConfig(ports.InsecureKubeControllerManagerPort) <span class="comment">// 又套了一层方法去实现一些通用的默认配置的初始化</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s := KubeControllerManagerOptions&#123;</span><br><span class="line">		Generic:         cmoptions.NewGenericControllerManagerConfigurationOptions(&amp;componentConfig.Generic),</span><br><span class="line">		KubeCloudShared: cmoptions.NewKubeCloudSharedOptions(&amp;componentConfig.KubeCloudShared),</span><br><span class="line">		ServiceController: &amp;cmoptions.ServiceControllerOptions&#123;</span><br><span class="line">			ServiceControllerConfiguration: &amp;componentConfig.ServiceController,</span><br><span class="line">		&#125;,</span><br><span class="line">		... <span class="comment">// 一堆controller的key-value对</span></span><br><span class="line">		... <span class="comment">// 一些认证方面的配置</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	... <span class="comment">// authentication/authorization/secureServing等默认配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// gc资源配置就在此处了，一般我们很少配置gc相关的配置，所以通过这里可以知道k8s中一般有哪些资源可能是需要gc的</span></span><br><span class="line">	gcIgnoredResources := <span class="built_in">make</span>([]garbagecollectorconfig.GroupResource, <span class="number">0</span>, <span class="built_in">len</span>(garbagecollector.DefaultIgnoredResources()))  <span class="comment">// 忽略gc的资源，缺省的只有一个events</span></span><br><span class="line">	<span class="keyword">for</span> r := <span class="keyword">range</span> garbagecollector.DefaultIgnoredResources() &#123;</span><br><span class="line">		gcIgnoredResources = <span class="built_in">append</span>(gcIgnoredResources, garbagecollectorconfig.GroupResource&#123;Group: r.Group, Resource: r.Resource&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.GarbageCollectorController.GCIgnoredResources = gcIgnoredResources</span><br><span class="line">	s.Generic.LeaderElection.ResourceName = <span class="string">"kube-controller-manager"</span></span><br><span class="line">	s.Generic.LeaderElection.ResourceNamespace = <span class="string">"kube-system"</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Run-c-config-CompletedConfig-stopCh-lt-chan-struct-回到controllermanager-go"><a href="#Run-c-config-CompletedConfig-stopCh-lt-chan-struct-回到controllermanager-go" class="headerlink" title="Run(c *config.CompletedConfig, stopCh &lt;-chan struct{}),回到controllermanager.go"></a>Run(c *config.CompletedConfig, stopCh &lt;-chan struct{}),回到controllermanager.go</h3><ol>
<li>源码总计有130+行，算是controllerManager业务逻辑的主干了</li>
<li>具体功能有：<ol>
<li>打印version</li>
<li>向/configz这个handler中放入controllerManager目前的配置内容</li>
<li>将选主(leaderelection)情况放到healthCheck中</li>
<li>创建mux，加入/healthz、/debug/pprof、/configz、/metrics等handler</li>
<li>根据配置使用安全或非安全的模式，如果是安全模式，有Authorization和Authentication，之后启动http server</li>
<li>定义run：初始化clientBuilder为了后续能获取controller的config和client；先初始化saController再初始化其他controller；启动相关的informer</li>
<li>如果不需要选主则直接执行run，否则选主成功才执行run</li>
</ol>
</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run runs the KubeControllerManagerOptions.  This should never exit.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(c *config.CompletedConfig, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	... <span class="comment">// 打印Version</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> cfgz, err := configz.New(ConfigzName); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		cfgz.Set(c.ComponentConfig) <span class="comment">// configz是一个map[string]*Config&#123;&#125;，把kubeController的配置项注册进去，key为kubecontrollermanager.config.k8s.io</span></span><br><span class="line">		<span class="comment">// controller server会持有一个路径为`/configz`的handler</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">"unable to register configz: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup any healthz checks we will want to use.</span></span><br><span class="line">	<span class="comment">// 为了HA 所以集群中可能有多个controllerManager，因此controllerManager通过apiserver/etcd选主；</span></span><br><span class="line">	<span class="comment">// 此处将选主情况做进healthCheck中</span></span><br><span class="line">	<span class="keyword">var</span> checks []healthz.HealthChecker</span><br><span class="line">	<span class="keyword">var</span> electionChecker *leaderelection.HealthzAdaptor</span><br><span class="line">	<span class="keyword">if</span> c.ComponentConfig.Generic.LeaderElection.LeaderElect &#123;</span><br><span class="line">		electionChecker = leaderelection.NewLeaderHealthzAdaptor(time.Second * <span class="number">20</span>)</span><br><span class="line">		checks = <span class="built_in">append</span>(checks, electionChecker)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start the controller manager HTTP server</span></span><br><span class="line">	<span class="comment">// unsecuredMux is the handler for these controller *after* authn/authz filters have been applied</span></span><br><span class="line">	<span class="keyword">var</span> unsecuredMux *mux.PathRecorderMux</span><br><span class="line">	<span class="keyword">if</span> c.SecureServing != <span class="literal">nil</span> &#123;</span><br><span class="line">	    <span class="comment">// 1. 创建mux，基础path设置成"controller-manager" 2. 给mux加入/healthz、/debug/pprof、/configz、/metrics等handler</span></span><br><span class="line">		unsecuredMux = genericcontrollermanager.NewBaseHandler(&amp;c.ComponentConfig.Generic.Debugging, checks...)</span><br><span class="line">		handler := genericcontrollermanager.BuildHandlerChain(unsecuredMux, &amp;c.Authorization, &amp;c.Authentication)</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handle stoppedCh returned by c.SecureServing.Serve</span></span><br><span class="line">		<span class="comment">// 开启server</span></span><br><span class="line">		<span class="keyword">if</span> _, err := c.SecureServing.Serve(handler, <span class="number">0</span>, stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> c.InsecureServing != <span class="literal">nil</span> &#123;</span><br><span class="line">		unsecuredMux = genericcontrollermanager.NewBaseHandler(&amp;c.ComponentConfig.Generic.Debugging, checks...)</span><br><span class="line">		insecureSuperuserAuthn := server.AuthenticationInfo&#123;Authenticator: &amp;server.InsecureSuperuser&#123;&#125;&#125;</span><br><span class="line">		handler := genericcontrollermanager.BuildHandlerChain(unsecuredMux, <span class="literal">nil</span>, &amp;insecureSuperuserAuthn)</span><br><span class="line">		<span class="keyword">if</span> err := c.InsecureServing.Serve(handler, <span class="number">0</span>, stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	run := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">		rootClientBuilder := controller.SimpleControllerClientBuilder&#123;</span><br><span class="line">			ClientConfig: c.Kubeconfig,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> clientBuilder controller.ControllerClientBuilder <span class="comment">// 通过clientBuilder可以通过name获取controller的config和client</span></span><br><span class="line">		<span class="keyword">if</span> c.ComponentConfig.KubeCloudShared.UseServiceAccountCredentials &#123;</span><br><span class="line">			... <span class="comment">// 在云环境中的clientBuilder</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			clientBuilder = rootClientBuilder</span><br><span class="line">		&#125;</span><br><span class="line">		controllerContext, err := CreateControllerContext(c, rootClientBuilder, clientBuilder, ctx.Done())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.Fatalf(<span class="string">"error building controller context: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 由于serverAccountToken的特殊性，必须先于其他controller启动</span></span><br><span class="line">		saTokenControllerInitFunc := serviceAccountTokenControllerStarter&#123;rootClientBuilder: rootClientBuilder&#125;.startServiceAccountTokenController</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动所有controllers。StartControllers见 2.4，NewControllerInitializers 见2.5</span></span><br><span class="line">		<span class="keyword">if</span> err := StartControllers(controllerContext, saTokenControllerInitFunc, NewControllerInitializers(controllerContext.LoopMode), unsecuredMux); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.Fatalf(<span class="string">"error starting controllers: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 用于controller的informers</span></span><br><span class="line">		controllerContext.InformerFactory.Start(controllerContext.Stop)</span><br><span class="line">		<span class="comment">// 用于typed资源本身或动态资源的metadata的informers；目前用到这个informerFactory的有ResourceQuota和GarbageCollector</span></span><br><span class="line">		controllerContext.ObjectOrMetadataInformerFactory.Start(controllerContext.Stop)</span><br><span class="line">		<span class="built_in">close</span>(controllerContext.InformersStarted)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;&#125; <span class="comment">// 阻塞当前线程</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有启用选主（集群中只有一个controllerManager的情况下），直接run</span></span><br><span class="line">	<span class="keyword">if</span> !c.ComponentConfig.Generic.LeaderElection.LeaderElect &#123;</span><br><span class="line">		run(context.TODO()) <span class="comment">// 这里定义了一个Done() 为 &lt;-chan struct&#123;&#125;，在select中作为一个永远不会触发的条件</span></span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"unreachable"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	id, err := os.Hostname()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// add a uniquifier so that two processes on the same host don't accidentally both become active</span></span><br><span class="line">	id = id + <span class="string">"_"</span> + <span class="keyword">string</span>(uuid.NewUUID())</span><br><span class="line"></span><br><span class="line">	rl, err := resourcelock.New(c.ComponentConfig.Generic.LeaderElection.ResourceLock,</span><br><span class="line">		c.ComponentConfig.Generic.LeaderElection.ResourceNamespace,</span><br><span class="line">		c.ComponentConfig.Generic.LeaderElection.ResourceName,</span><br><span class="line">		c.LeaderElectionClient.CoreV1(),</span><br><span class="line">		c.LeaderElectionClient.CoordinationV1(),</span><br><span class="line">		resourcelock.ResourceLockConfig&#123;</span><br><span class="line">			Identity:      id,</span><br><span class="line">			EventRecorder: c.EventRecorder,</span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">"error creating lock: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 选主，成为主才执行run</span></span><br><span class="line">	leaderelection.RunOrDie(context.TODO(), leaderelection.LeaderElectionConfig&#123;</span><br><span class="line">		Lock:          rl,</span><br><span class="line">		LeaseDuration: c.ComponentConfig.Generic.LeaderElection.LeaseDuration.Duration,</span><br><span class="line">		RenewDeadline: c.ComponentConfig.Generic.LeaderElection.RenewDeadline.Duration,</span><br><span class="line">		RetryPeriod:   c.ComponentConfig.Generic.LeaderElection.RetryPeriod.Duration,</span><br><span class="line">		Callbacks: leaderelection.LeaderCallbacks&#123;</span><br><span class="line">			OnStartedLeading: run,</span><br><span class="line">			OnStoppedLeading: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				klog.Fatalf(<span class="string">"leaderelection lost"</span>)</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		WatchDog: electionChecker,</span><br><span class="line">		Name:     <span class="string">"kube-controller-manager"</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="built_in">panic</span>(<span class="string">"unreachable"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StartControllers-在controolermanager-go中"><a href="#StartControllers-在controolermanager-go中" class="headerlink" title="StartControllers,在controolermanager.go中"></a>StartControllers,在controolermanager.go中</h3><ol>
<li>通过传入的ctx和initFunc启动saTokenController</li>
<li>通过传入的ctx和controllers，调用每个controller的initFunc分别对其进行初始化</li>
<li>往mux中添加一些debug的handler</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StartControllers starts a set of controllers with a specified ControllerContext</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartControllers</span><span class="params">(ctx ControllerContext, startSATokenController InitFunc, controllers <span class="keyword">map</span>[<span class="keyword">string</span>]InitFunc, unsecuredMux *mux.PathRecorderMux)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Always start the SA token controller first using a full-power client, since it needs to mint tokens for the rest</span></span><br><span class="line">	<span class="comment">// If this fails, just return here and fail since other controllers won't be able to get credentials.</span></span><br><span class="line">	<span class="keyword">if</span> _, _, err := startSATokenController(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the cloud provider with a reference to the clientBuilder only after token controller</span></span><br><span class="line">	<span class="comment">// has started in case the cloud provider uses the client builder.</span></span><br><span class="line">	<span class="keyword">if</span> ctx.Cloud != <span class="literal">nil</span> &#123;</span><br><span class="line">		ctx.Cloud.Initialize(ctx.ClientBuilder, ctx.Stop)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> controllerName, initFn := <span class="keyword">range</span> controllers &#123;</span><br><span class="line">		<span class="keyword">if</span> !ctx.IsControllerEnabled(controllerName) &#123;</span><br><span class="line">			klog.Warningf(<span class="string">"%q is disabled"</span>, controllerName)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		time.Sleep(wait.Jitter(ctx.ComponentConfig.Generic.ControllerStartInterval.Duration, ControllerStartJitter))</span><br><span class="line"></span><br><span class="line">		klog.V(<span class="number">1</span>).Infof(<span class="string">"Starting %q"</span>, controllerName)</span><br><span class="line">		debugHandler, started, err := initFn(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.Errorf(<span class="string">"Error starting %q"</span>, controllerName)</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !started &#123;</span><br><span class="line">			klog.Warningf(<span class="string">"Skipping %q"</span>, controllerName)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> debugHandler != <span class="literal">nil</span> &amp;&amp; unsecuredMux != <span class="literal">nil</span> &#123;</span><br><span class="line">			basePath := <span class="string">"/debug/controllers/"</span> + controllerName</span><br><span class="line">			unsecuredMux.UnlistedHandle(basePath, http.StripPrefix(basePath, debugHandler))</span><br><span class="line">			unsecuredMux.UnlistedHandlePrefix(basePath+<span class="string">"/"</span>, http.StripPrefix(basePath, debugHandler))</span><br><span class="line">		&#125;</span><br><span class="line">		klog.Infof(<span class="string">"Started %q"</span>, controllerName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NewControllerInitializers-在controllermanager-go中"><a href="#NewControllerInitializers-在controllermanager-go中" class="headerlink" title="NewControllerInitializers,在controllermanager.go中"></a>NewControllerInitializers,在controllermanager.go中</h3><p>此处定义了每个controller的初始化方法，其内容大同小异，所以2.6选取比较简单的namespace进行分析</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewControllerInitializers is a public map of named controller groups (you can start more than one in an init func)</span></span><br><span class="line"><span class="comment">// paired to their InitFunc.  This allows for structured downstream composition and subdivision.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewControllerInitializers</span><span class="params">(loopMode ControllerLoopMode)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">InitFunc</span></span> &#123;</span><br><span class="line">	controllers := <span class="keyword">map</span>[<span class="keyword">string</span>]InitFunc&#123;&#125;</span><br><span class="line">	controllers[<span class="string">"endpoint"</span>] = startEndpointController</span><br><span class="line">	controllers[<span class="string">"endpointslice"</span>] = startEndpointSliceController</span><br><span class="line">	controllers[<span class="string">"replicationcontroller"</span>] = startReplicationController</span><br><span class="line">	controllers[<span class="string">"podgc"</span>] = startPodGCController</span><br><span class="line">	controllers[<span class="string">"resourcequota"</span>] = startResourceQuotaController</span><br><span class="line">	controllers[<span class="string">"namespace"</span>] = startNamespaceController</span><br><span class="line">	controllers[<span class="string">"serviceaccount"</span>] = startServiceAccountController</span><br><span class="line">	controllers[<span class="string">"garbagecollector"</span>] = startGarbageCollectorController</span><br><span class="line">	controllers[<span class="string">"daemonset"</span>] = startDaemonSetController</span><br><span class="line">	controllers[<span class="string">"job"</span>] = startJobController</span><br><span class="line">	controllers[<span class="string">"deployment"</span>] = startDeploymentController</span><br><span class="line">	controllers[<span class="string">"replicaset"</span>] = startReplicaSetController</span><br><span class="line">	controllers[<span class="string">"horizontalpodautoscaling"</span>] = startHPAController</span><br><span class="line">	controllers[<span class="string">"disruption"</span>] = startDisruptionController</span><br><span class="line">	controllers[<span class="string">"statefulset"</span>] = startStatefulSetController</span><br><span class="line">	controllers[<span class="string">"cronjob"</span>] = startCronJobController</span><br><span class="line">	controllers[<span class="string">"csrsigning"</span>] = startCSRSigningController</span><br><span class="line">	controllers[<span class="string">"csrapproving"</span>] = startCSRApprovingController</span><br><span class="line">	controllers[<span class="string">"csrcleaner"</span>] = startCSRCleanerController</span><br><span class="line">	controllers[<span class="string">"ttl"</span>] = startTTLController</span><br><span class="line">	controllers[<span class="string">"bootstrapsigner"</span>] = startBootstrapSignerController</span><br><span class="line">	controllers[<span class="string">"tokencleaner"</span>] = startTokenCleanerController</span><br><span class="line">	controllers[<span class="string">"nodeipam"</span>] = startNodeIpamController</span><br><span class="line">	controllers[<span class="string">"nodelifecycle"</span>] = startNodeLifecycleController</span><br><span class="line">	<span class="keyword">if</span> loopMode == IncludeCloudLoops &#123;</span><br><span class="line">		controllers[<span class="string">"service"</span>] = startServiceController</span><br><span class="line">		controllers[<span class="string">"route"</span>] = startRouteController</span><br><span class="line">		controllers[<span class="string">"cloud-node-lifecycle"</span>] = startCloudNodeLifecycleController</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> volume controller into the IncludeCloudLoops only set.</span></span><br><span class="line">	&#125;</span><br><span class="line">	controllers[<span class="string">"persistentvolume-binder"</span>] = startPersistentVolumeBinderController</span><br><span class="line">	controllers[<span class="string">"attachdetach"</span>] = startAttachDetachController</span><br><span class="line">	controllers[<span class="string">"persistentvolume-expander"</span>] = startVolumeExpandController</span><br><span class="line">	controllers[<span class="string">"clusterrole-aggregation"</span>] = startClusterRoleAggregrationController</span><br><span class="line">	controllers[<span class="string">"pvc-protection"</span>] = startPVCProtectionController</span><br><span class="line">	controllers[<span class="string">"pv-protection"</span>] = startPVProtectionController</span><br><span class="line">	controllers[<span class="string">"ttl-after-finished"</span>] = startTTLAfterFinishedController</span><br><span class="line">	controllers[<span class="string">"root-ca-cert-publisher"</span>] = startRootCACertPublisher</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> controllers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="startNamespaceController-在core-go中"><a href="#startNamespaceController-在core-go中" class="headerlink" title="startNamespaceController,在core.go中"></a>startNamespaceController,在core.go中</h3><ol>
<li>startNamespaceController初始化了用于namespace-controller的client(就是一个访问apiserver的kube-client实例，设置了UserAgent)，然后调用startModifiedNamespaceController</li>
<li>startModifiedNamespaceController中初始化了真正的namespace控制器，然后起了一个goroutine去管理namespace</li>
<li>启用多个goroutine（缺省为10个），每个goroutine中一个worker处理具体逻辑</li>
<li>worker中最外围是一个loop，循环往复地执行处理逻辑<ol>
<li>尝试从队列中获取一个key</li>
<li>根据这个key尝试同步namespace信息:syncNamespaceFromKey；由于namespace的操作只有delete（在enqueueNamespace这个方法中删除了除delete namespace外的其他操作）了，所以此处的同步即从apiserver中删除key对应的namespace，具体代码在<code>func (d *namespacedResourcesDeleter) deleteAllContent(ns *v1.Namespace) (int64, error)</code></li>
<li>如果成功，从队列中删除这个key并返回</li>
<li>如果不成功，判断是什么类型的错误<ol>
<li>如果是deletion.ResourcesRemainingError（namespace下还有其他资源），则在一段时间后加入队列</li>
<li>如果不是，则直接将key重新加入队列</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startNamespaceController</span><span class="params">(ctx ControllerContext)</span> <span class="params">(http.Handler, <span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// the namespace cleanup controller is very chatty.  It makes lots of discovery calls and then it makes lots of delete calls</span></span><br><span class="line">	<span class="comment">// the ratelimiter negatively affects its speed.  Deleting 100 total items in a namespace (that's only a few of each resource</span></span><br><span class="line">	<span class="comment">// including events), takes ~10 seconds by default.</span></span><br><span class="line">	nsKubeconfig := ctx.ClientBuilder.ConfigOrDie(<span class="string">"namespace-controller"</span>)</span><br><span class="line">	nsKubeconfig.QPS *= <span class="number">20</span></span><br><span class="line">	nsKubeconfig.Burst *= <span class="number">100</span></span><br><span class="line">	namespaceKubeClient := clientset.NewForConfigOrDie(nsKubeconfig)</span><br><span class="line">	<span class="keyword">return</span> startModifiedNamespaceController(ctx, namespaceKubeClient, nsKubeconfig)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startModifiedNamespaceController</span><span class="params">(ctx ControllerContext, namespaceKubeClient clientset.Interface, nsKubeconfig *restclient.Config)</span> <span class="params">(http.Handler, <span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	metadataClient, err := metadata.NewForConfig(nsKubeconfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">true</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	discoverResourcesFn := namespaceKubeClient.Discovery().ServerPreferredNamespacedResources</span><br><span class="line"></span><br><span class="line">	namespaceController := namespacecontroller.NewNamespaceController(</span><br><span class="line">		namespaceKubeClient,</span><br><span class="line">		metadataClient,</span><br><span class="line">		discoverResourcesFn,</span><br><span class="line">		ctx.InformerFactory.Core().V1().Namespaces(),</span><br><span class="line">		ctx.ComponentConfig.NamespaceController.NamespaceSyncPeriod.Duration,</span><br><span class="line">		v1.FinalizerKubernetes,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">go</span> namespaceController.Run(<span class="keyword">int</span>(ctx.ComponentConfig.NamespaceController.ConcurrentNamespaceSyncs), ctx.Stop)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来到<code>namespace_controller.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run starts observing the system with the specified number of workers.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nm *NamespaceController)</span> <span class="title">Run</span><span class="params">(workers <span class="keyword">int</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> utilruntime.HandleCrash()</span><br><span class="line">	<span class="keyword">defer</span> nm.queue.ShutDown()</span><br><span class="line"></span><br><span class="line">	klog.Infof(<span class="string">"Starting namespace controller"</span>)</span><br><span class="line">	<span class="keyword">defer</span> klog.Infof(<span class="string">"Shutting down namespace controller"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !cache.WaitForNamedCacheSync(<span class="string">"namespace"</span>, stopCh, nm.listerSynced) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.V(<span class="number">5</span>).Info(<span class="string">"Starting workers of namespace controller"</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workers; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> wait.Until(nm.worker, time.Second, stopCh)</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;-stopCh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// worker processes the queue of namespace objects.</span></span><br><span class="line"><span class="comment">// Each namespace can be in the queue at most once.</span></span><br><span class="line"><span class="comment">// The system ensures that no two workers can process</span></span><br><span class="line"><span class="comment">// the same namespace at the same time.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nm *NamespaceController)</span> <span class="title">worker</span><span class="params">()</span></span> &#123;</span><br><span class="line">	workFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">		key, quit := nm.queue.Get()</span><br><span class="line">		<span class="keyword">if</span> quit &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> nm.queue.Done(key)</span><br><span class="line"></span><br><span class="line">		err := nm.syncNamespaceFromKey(key.(<span class="keyword">string</span>))</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// no error, forget this entry and return</span></span><br><span class="line">			nm.queue.Forget(key)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> estimate, ok := err.(*deletion.ResourcesRemainingError); ok &#123;</span><br><span class="line">			t := estimate.Estimate/<span class="number">2</span> + <span class="number">1</span></span><br><span class="line">			klog.V(<span class="number">4</span>).Infof(<span class="string">"Content remaining in namespace %s, waiting %d seconds"</span>, key, t)</span><br><span class="line">			nm.queue.AddAfter(key, time.Duration(t)*time.Second)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// rather than wait for a full resync, re-add the namespace to the queue to be processed</span></span><br><span class="line">			nm.queue.AddRateLimited(key)</span><br><span class="line">			utilruntime.HandleError(fmt.Errorf(<span class="string">"deletion of namespace %v failed: %v"</span>, key, err))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		quit := workFunc()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> quit &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参见client-go的例子"><a href="#参见client-go的例子" class="headerlink" title="参见client-go的例子"></a>参见client-go的例子</h3><p>官方提供的一个client使用workqueue的例子很好地描述了controller的大致实现，可以作为一个非常标准的模板用于参考。</p>
<p><code>https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go</code></p>
<blockquote><p>同步自 <a href="https://github.com/pangsq/read_code_of_k8s/blob/master/controller-manager-entry.md" target="_blank" rel="noopener">https://github.com/pangsq/read_code_of_k8s/blob/master/controller-manager-entry.md</a></p>
</blockquote></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">锋寒</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.pangsq.cn/2020/05/02/controllerManagerEntry/index/">https://blog.pangsq.cn/2020/05/02/controllerManagerEntry/index/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.pangsq.cn">锋寒的博客</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/Controller/">Controller</a><a class="post-meta__tags" href="/tags/Golang/">Golang</a><a class="post-meta__tags" href="/tags/Entry/">Entry</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/05/03/build-your-blog/"><i class="fa fa-chevron-left">  </i><span>使用Hexo + Github Pages搭建个人博客</span></a></div><div class="next-post pull-right"><a href="/2020/05/01/gin_router_2/index/"><span>Gin路由分析（二）</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By 锋寒</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>