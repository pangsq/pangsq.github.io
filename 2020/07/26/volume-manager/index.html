<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="kubelet源码阅读 -- volumeManager"><meta name="keywords" content="Kubernetes,Kubelet,Volume,Source"><meta name="author" content="锋寒"><meta name="copyright" content="锋寒"><title>kubelet源码阅读 -- volumeManager | 锋寒的博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#volumeManager"><span class="toc-number">1.</span> <span class="toc-text">volumeManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#调用"><span class="toc-number">1.1.</span> <span class="toc-text">调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结构体"><span class="toc-number">1.2.</span> <span class="toc-text">结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接口"><span class="toc-number">1.3.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行流程"><span class="toc-number">1.4.</span> <span class="toc-text">运行流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#desiredStateOfWorld"><span class="toc-number">2.</span> <span class="toc-text">desiredStateOfWorld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#actualStateOfWorld"><span class="toc-number">3.</span> <span class="toc-text">actualStateOfWorld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#desiredStateOfWorldPopulator"><span class="toc-number">4.</span> <span class="toc-text">desiredStateOfWorldPopulator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reconciler"><span class="toc-number">5.</span> <span class="toc-text">reconciler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#operationExecutor"><span class="toc-number">6.</span> <span class="toc-text">operationExecutor</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">锋寒</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">9</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">锋寒的博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">kubelet源码阅读 -- volumeManager</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kubernetes/">Kubernetes</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kubernetes/Source/">Source</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>volumeManager是kubelet中对volumes进行attached/mounted/unmounted/detached等操作的执行者。</p>
<p>代码版本：release-1.11   commit:901674</p>
<h2 id="volumeManager"><a href="#volumeManager" class="headerlink" title="volumeManager"></a>volumeManager</h2><h3 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Run中启动volumeManager独立的协程</span><br><span class="line">   <span class="keyword">go</span> kl.volumeManager.Run(kl.sourcesReady, wait.NeverStop))</span><br><span class="line"><span class="number">2.</span> syncPod中阻塞等待Pod的attach和mount完成</span><br><span class="line">   <span class="keyword">if</span> !kl.podIsTerminated(pod) </span><br><span class="line">       <span class="keyword">if</span> err := kl.volumeManager.WaitForAttachAndMount(pod); err != <span class="literal">nil</span> &#123;</span><br><span class="line">           <span class="comment">// record event和log error</span></span><br><span class="line">           <span class="keyword">return</span> err</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> volumeManager <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// kube client，由DesiredStateOfWorldPopulator调用从API server获取PV和PVC</span></span><br><span class="line">   kubeClient clientset.Interface</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 用于访问各种不同volume插件</span></span><br><span class="line">   volumePluginMgr *volume.VolumePluginMgr</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 记录volumes的目标状态，如哪些volumes需要被attached，哪些pod引用volumes。</span></span><br><span class="line">   <span class="comment">// kubelet pod manager将会用到这个信息</span></span><br><span class="line">   <span class="comment">// 简称dsw</span></span><br><span class="line">   desiredStateOfWorld cache.DesiredStateOfWorld</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 记录volumes的当前状态，与desiredStateOfWorld相对应</span></span><br><span class="line">   <span class="comment">// kubelet pod manager同样会用到这个信息</span></span><br><span class="line">   <span class="comment">// 简称asw</span></span><br><span class="line">   actualStateOfWorld cache.ActualStateOfWorld</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 生成异步的attach/detach/mount/unmount操作</span></span><br><span class="line">   operationExecutor operationexecutor.OperationExecutor</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 调整actualStateOfWorld</span></span><br><span class="line">   <span class="comment">// 调谐器，通过operationExecutor的attach/detach/mount/unmount操作对volumes进行异步的周期性的调谐</span></span><br><span class="line">   <span class="comment">// 从 actualStateOfWorld 到 desiredStateOfWorld</span></span><br><span class="line">   reconciler reconciler.Reconciler</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 维护desiredStateOfWorld</span></span><br><span class="line">   <span class="comment">// 调用podManager异步地周期性地生成desiredStateOfWorld</span></span><br><span class="line">   desiredStateOfWorldPopulator populator.DesiredStateOfWorldPopulator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> VolumeManager <span class="keyword">interface</span> &#123;</span><br><span class="line">   <span class="comment">// 启动volume manager，触发所有异步的loops</span></span><br><span class="line">   Run(sourcesReady config.SourcesReady, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 同步阻塞地等待volumes被attached和mounted（从actualStateOfWorld中获取状态）</span></span><br><span class="line">   <span class="comment">// 等待时间超过podAttachAndMountTimeout时返回错误</span></span><br><span class="line">   WaitForAttachAndMount(pod *v1.Pod) error</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 返回Pod的已成功attached和mounted的volumes</span></span><br><span class="line">   GetMountedVolumesForPod(podName types.UniquePodName) container.VolumeMap</span><br><span class="line"></span><br><span class="line">   <span class="comment">// pv的annations中可定义pv.beta.kubernetes.io/gid以指定额外的user group id</span></span><br><span class="line">   <span class="comment">// 当pod.Spec.SecurityContext.SupplementalGroups也包含该gid时，该gid就算作pod的extraSupplementalGroups</span></span><br><span class="line">   <span class="comment">// kuberuntime在创建容器时将会用到这个信息，将用户组添加到容器中；与fsGroup搭配使用，fsGroup指定挂载volume的用户组</span></span><br><span class="line">   GetExtraSupplementalGroupsForPod(pod *v1.Pod) []<span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 获取正在使用的volumes。"正在使用"的标准是volume在desiredStateOfWorld中（即当volume被attached前就算作in use），直到desiredStateOfWorld和actualStateOfWorld中不再有这个volume或者被unmounted</span></span><br><span class="line">   GetVolumesInUse() []v1.UniqueVolumeName</span><br><span class="line"></span><br><span class="line">   <span class="comment">// kubelet启动后初始的actual states被全部同步完成</span></span><br><span class="line">   ReconcilerStatesHasBeenSynced() <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// volume是否被attached</span></span><br><span class="line">   VolumeIsAttached(volumeName v1.UniqueVolumeName) <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 将dsw记录的volumes标记为in use</span></span><br><span class="line">   MarkVolumesAsReportedInUse(volumesReportedAsInUse []v1.UniqueVolumeName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行流程"><a href="#运行流程" class="headerlink" title="运行流程"></a>运行流程</h3><p>volumeManager的启动会带起desiredStateOfWorldPopulator.Run和reconciler.Run两个协程</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// kubelet的配置来源有三种：file/http/apiserver；传入的sourcesReady可以用于判断三种来源是否都已ready</span></span><br><span class="line"><span class="keyword">go</span> vm.desiredStateOfWorldPopulator.Run(sourcesReady, stopCh)</span><br><span class="line"><span class="keyword">go</span> vm.reconciler.Run(stopCh)</span><br></pre></td></tr></table></figure>

<h2 id="desiredStateOfWorld"><a href="#desiredStateOfWorld" class="headerlink" title="desiredStateOfWorld"></a>desiredStateOfWorld</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> desiredStateOfWorld <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// dsw核心就是此map，用于记录每个volume被哪些pod使用</span></span><br><span class="line">   volumesToMount <span class="keyword">map</span>[v1.UniqueVolumeName]volumeToMount</span><br><span class="line">   <span class="comment">// 维护已知的volumePlugin。用于区分volume是否是attachable的，影响UniqueVolumeName的生成</span></span><br><span class="line">   <span class="comment">// attachable的volumeName格式为&#123;pluginName&#125;/&#123;volumePlugin.GetVolumeName(volumeName)&#125;，而非attachable的volumeName格式为&#123;pluginName&#125;/&#123;podName&#125;-&#123;volumeSpec.Name&#125;</span></span><br><span class="line">   <span class="comment">// 例如对于csiPlugin来说，最终的volumeName为kubernetes.io/csi/&#123;csi.Driver&#125;^&#123;csi.VolumeHandle&#125;</span></span><br><span class="line">   volumePluginMgr *volume.VolumePluginMgr</span><br><span class="line">   sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> volumeToMount <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// volumeName</span></span><br><span class="line">   volumeName v1.UniqueVolumeName</span><br><span class="line">   <span class="comment">// 使用该volume的pods</span></span><br><span class="line">   podsToMount <span class="keyword">map</span>[types.UniquePodName]podToMount</span><br><span class="line">   <span class="comment">// volume是否是attachable的</span></span><br><span class="line">   pluginIsAttachable <span class="keyword">bool</span></span><br><span class="line">   <span class="comment">// volume的gid，从annotation中获取</span></span><br><span class="line">   volumeGidValue <span class="keyword">string</span></span><br><span class="line">   <span class="comment">// node.Status.VolumesInUse是否已包含本volume</span></span><br><span class="line">   reportedInUse <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="actualStateOfWorld"><a href="#actualStateOfWorld" class="headerlink" title="actualStateOfWorld"></a>actualStateOfWorld</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> actualStateOfWorld <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// 节点名</span></span><br><span class="line">   nodeName types.NodeName</span><br><span class="line">   <span class="comment">// 记录attached的volume</span></span><br><span class="line">   attachedVolumes <span class="keyword">map</span>[v1.UniqueVolumeName]attachedVolume</span><br><span class="line">   <span class="comment">// 维护所有volumePlugin</span></span><br><span class="line">   volumePluginMgr *volume.VolumePluginMgr</span><br><span class="line">   </span><br><span class="line">   sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> attachedVolume <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// volumeName</span></span><br><span class="line">   volumeName v1.UniqueVolumeName</span><br><span class="line">   <span class="comment">// 已成功mount的pod</span></span><br><span class="line">   mountedPods <span class="keyword">map</span>[volumetypes.UniquePodName]mountedPod</span><br><span class="line">   <span class="comment">// volume spec，unmount会用到以下的路径</span></span><br><span class="line">   <span class="comment">// /var/lib/kubelet/pods/&#123;podUID&#125;/volumes/&#123;escapeQualifiedPluginName&#125;/&#123;volumeSpecName&#125;/</span></span><br><span class="line">   spec *volume.Spec</span><br><span class="line">   <span class="comment">// pluginName</span></span><br><span class="line">   pluginName <span class="keyword">string</span></span><br><span class="line">   <span class="comment">// pluginIsAttachable</span></span><br><span class="line">   pluginIsAttachable <span class="keyword">bool</span></span><br><span class="line">   <span class="comment">// volume是否被挂载在一个公共的mount path目录底下</span></span><br><span class="line">   globallyMounted <span class="keyword">bool</span></span><br><span class="line">   <span class="comment">// volume attach的路径</span></span><br><span class="line">   devicePath <span class="keyword">string</span></span><br><span class="line">   <span class="comment">// 块设备被挂载的路径</span></span><br><span class="line">   deviceMountPath <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="desiredStateOfWorldPopulator"><a href="#desiredStateOfWorldPopulator" class="headerlink" title="desiredStateOfWorldPopulator"></a>desiredStateOfWorldPopulator</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">Run</span><span class="params">(sourcesReady config.SourcesReady, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">   <span class="comment">// 周期性地执行populaterLoopFunc;hasAddedPods状态信息是reconciler将会用到</span></span><br><span class="line">   <span class="comment">// 而对于populaterLoopFunc本身，无论sources是否AllReady都不影响运行</span></span><br><span class="line">   wait.PollUntil(dswp.loopSleepDuration, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">      done := sourcesReady.AllReady()</span><br><span class="line">      dswp.populatorLoopFunc()()</span><br><span class="line">      <span class="keyword">return</span> done, <span class="literal">nil</span></span><br><span class="line">   &#125;, stopCh)</span><br><span class="line">   dswp.hasAddedPodsLock.Lock()</span><br><span class="line">   dswp.hasAddedPods = <span class="literal">true</span></span><br><span class="line">   dswp.hasAddedPodsLock.Unlock()</span><br><span class="line">   wait.Until(dswp.populatorLoopFunc(), dswp.loopSleepDuration, stopCh)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">populatorLoopFunc</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      dswp.findAndAddNewPods()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// findAndRemoveDeletedPods()是一个非常耗时的操作，所以通过设置调用间隔以限制调用速率</span></span><br><span class="line">      <span class="keyword">if</span> time.Since(dswp.timeOfLastGetPodStatus) &lt; dswp.getPodStatusRetryDuration &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      dswp.findAndRemoveDeletedPods()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">findAndAddNewPods</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// Map unique pod name to outer volume name to MountedVolume.</span></span><br><span class="line">   mountedVolumesForPod := <span class="built_in">make</span>(<span class="keyword">map</span>[volumetypes.UniquePodName]<span class="keyword">map</span>[<span class="keyword">string</span>]cache.MountedVolume)</span><br><span class="line">   <span class="comment">// 如果开启了实时扩容功能，那么正在被使用中的pod volume，其容量会发生变化，所以先将asw中的moutedVolumes记录下来，具体用处下文分析</span></span><br><span class="line">   <span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.ExpandInUsePersistentVolumes) &#123;</span><br><span class="line">      <span class="keyword">for</span> _, mountedVolume := <span class="keyword">range</span> dswp.actualStateOfWorld.GetMountedVolumes() &#123;</span><br><span class="line">         mountedVolumes, exist := mountedVolumesForPod[mountedVolume.PodName]</span><br><span class="line">         <span class="keyword">if</span> !exist &#123;</span><br><span class="line">            mountedVolumes = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]cache.MountedVolume)</span><br><span class="line">            mountedVolumesForPod[mountedVolume.PodName] = mountedVolumes</span><br><span class="line">         &#125;</span><br><span class="line">         mountedVolumes[mountedVolume.OuterVolumeSpecName] = mountedVolume</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 记录有resize过的volumes，因为一个volume的resize只要执行一次即可</span></span><br><span class="line">   <span class="comment">// 如果多个pod都使用同一个volume，为了避免多次执行，所以记录下volume</span></span><br><span class="line">   processedVolumesForFSResize := sets.NewString()</span><br><span class="line">   <span class="comment">// kubelet的多个组件都会用到podManager，podManager维护节点上的pods</span></span><br><span class="line">   <span class="keyword">for</span> _, pod := <span class="keyword">range</span> dswp.podManager.GetPods() &#123;</span><br><span class="line">      <span class="keyword">if</span> dswp.isPodTerminated(pod) &#123;</span><br><span class="line">         <span class="comment">// Do not (re)add volumes for terminated pods</span></span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      dswp.processPodVolumes(pod, mountedVolumesForPod, processedVolumesForFSResize)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">processPodVolumes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   pod *v1.Pod,</span></span></span><br><span class="line"><span class="function"><span class="params">   mountedVolumesForPod <span class="keyword">map</span>[volumetypes.UniquePodName]<span class="keyword">map</span>[<span class="keyword">string</span>]cache.MountedVolume,</span></span></span><br><span class="line"><span class="function"><span class="params">   processedVolumesForFSResize sets.String)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> pod == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   uniquePodName := util.GetUniquePodName(pod)</span><br><span class="line">   <span class="comment">// 已经处理过的pod不再处理；已处理过的pod会记录在dswp.pods.processedPods中</span></span><br><span class="line">   <span class="keyword">if</span> dswp.podPreviouslyProcessed(uniquePodName) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   allVolumesAdded := <span class="literal">true</span></span><br><span class="line">   <span class="comment">// 生成两个volumeMap，分别对应普通的挂载卷和块设备</span></span><br><span class="line">   mountsMap, devicesMap := dswp.makeVolumeMap(pod.Spec.Containers)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process volume spec for each volume defined in pod</span></span><br><span class="line">   <span class="keyword">for</span> _, podVolume := <span class="keyword">range</span> pod.Spec.Volumes &#123;</span><br><span class="line">       <span class="comment">// 如果podVolume是pvc类型的，则根据pvc名字找到与其bound的pv，获取pv信息</span></span><br><span class="line">      pvc, volumeSpec, volumeGidValue, err :=</span><br><span class="line">         dswp.createVolumeSpec(podVolume, pod.Name, pod.Namespace, mountsMap, devicesMap)</span><br><span class="line">      <span class="comment">// error handle</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将volume信息记录在dsw中</span></span><br><span class="line">      _, err = dswp.desiredStateOfWorld.AddPodToVolume(</span><br><span class="line">         uniquePodName, pod, volumeSpec, podVolume.Name, volumeGidValue)</span><br><span class="line">      <span class="comment">// error handle</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 如果开启volume扩容功能，那么会通过pvc.Status.Capacity[v1.ResourceStorage]和pvc.Spec.Capacity[v1.ResourceStorage]进行比较，</span></span><br><span class="line">      <span class="comment">// 来判断是否执行dswp.actualStateOfWorld.MarkFSResizeRequired</span></span><br><span class="line">      <span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.ExpandInUsePersistentVolumes) &#123;</span><br><span class="line">         dswp.checkVolumeFSResize(pod, podVolume, pvc, volumeSpec,</span><br><span class="line">            uniquePodName, mountedVolumesForPod, processedVolumesForFSResize)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// some of the volume additions may have failed, should not mark this pod as fully processed</span></span><br><span class="line">   <span class="keyword">if</span> allVolumesAdded &#123;</span><br><span class="line">       <span class="comment">// 记录过已处理过的pod，即放入dswp.pods.processedPods中</span></span><br><span class="line">      dswp.markPodProcessed(uniquePodName)</span><br><span class="line">      <span class="comment">// 当所有pod的所有volume添加后，个别类型volume可能需要remount，例如DownwardAPI</span></span><br><span class="line">      dswp.actualStateOfWorld.MarkRemountRequired(uniquePodName)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">findAndRemoveDeletedPods</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">var</span> runningPods []*kubecontainer.Pod</span><br><span class="line"></span><br><span class="line">   runningPodsFetched := <span class="literal">false</span></span><br><span class="line">   <span class="comment">// 从dsw中获取所有volumes，</span></span><br><span class="line">   <span class="keyword">for</span> _, volumeToMount := <span class="keyword">range</span> dswp.desiredStateOfWorld.GetVolumesToMount() &#123;</span><br><span class="line">      pod, podExists := dswp.podManager.GetPodByUID(volumeToMount.Pod.UID)</span><br><span class="line">      <span class="keyword">if</span> podExists &#123;</span><br><span class="line">         <span class="comment">// Skip running pods</span></span><br><span class="line">         <span class="keyword">if</span> !dswp.isPodTerminated(pod) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> dswp.keepTerminatedPodVolumes &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 一次findAndRemoveDeletedPods中只执行一次dswp.kubeContainerRuntime.GetPods</span></span><br><span class="line">      <span class="keyword">if</span> !runningPodsFetched &#123;</span><br><span class="line">         <span class="keyword">var</span> getPodsErr error</span><br><span class="line">         runningPods, getPodsErr = dswp.kubeContainerRuntime.GetPods(<span class="literal">false</span>)</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">         runningPodsFetched = <span class="literal">true</span></span><br><span class="line">         dswp.timeOfLastGetPodStatus = time.Now()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      runningContainers := <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 检查volume对应的pod是否存在，且其包含的container是否存在</span></span><br><span class="line">      <span class="keyword">for</span> _, runningPod := <span class="keyword">range</span> runningPods &#123;</span><br><span class="line">         <span class="keyword">if</span> runningPod.ID == volumeToMount.Pod.UID &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(runningPod.Containers) &gt; <span class="number">0</span> &#123;</span><br><span class="line">               runningContainers = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> runningContainers &#123;</span><br><span class="line">        <span class="comment">// 如果相关的（即使用了该volume的pod包含的）containers还存在，则暂时不从volumeManager中将其移除</span></span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> !dswp.actualStateOfWorld.VolumeExists(volumeToMount.VolumeName) &amp;&amp; podExists &#123;</span><br><span class="line">         <span class="comment">// 如果asw中不包含该volume了，且pod还存在</span></span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dsw记录了volume和pod信息，即volume被使用在哪些pod中</span></span><br><span class="line">      <span class="comment">// 此方法在volume下移除pod信息，如果一个volume不被任何pod使用，则该volume也需要被删除</span></span><br><span class="line">      dswp.desiredStateOfWorld.DeletePodFromVolume(</span><br><span class="line">         volumeToMount.PodName, volumeToMount.VolumeName)</span><br><span class="line">         <span class="comment">//从dswp.pods.processedPods中移除</span></span><br><span class="line">      dswp.deleteProcessedPod(volumeToMount.PodName)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 输入信息：</span><br><span class="line">a) 处理的对象是podManager.GetPods()</span><br><span class="line">b) actualStateOfWorld.GetMountedVolumes()，获取asw中已挂载的volume，用于resize处理</span><br><span class="line">c) desiredStateOfWorld.GetVolumesToMount()，获取dsw中记录的volumeMount，即volume被哪个pod挂载信息，以便之后处理pod已不存在的情况下删除volumeToMount信息</span><br><span class="line">d) podManager.GetPodByUID(...)，用于检查pod是否还存在</span><br><span class="line"></span><br><span class="line">2. 输出操作：对新增的pod执行abc,对删除的pod执行d</span><br><span class="line">a) 通过desiredStateOfWorld.AddPodToVolume(...)将pod的volume信息记录在dsw中（每个pod只处理一次)</span><br><span class="line">b) 调用actualStateOfWorld.MarkFSResizeRequired(...)将需要扩容调整的volume做标记</span><br><span class="line">c) 调用actualStateOfWorld.MarkRemountRequired(...)对需要remount的volume进行remount</span><br><span class="line">d) 调用desiredStateOfWorld.DeletePodFromVolume(...)将pod的volume信息从dsw中删除</span><br></pre></td></tr></table></figure>

<h2 id="reconciler"><a href="#reconciler" class="headerlink" title="reconciler"></a>reconciler</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">   wait.Until(rc.reconciliationLoopFunc(), rc.loopSleepDuration, stopCh)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">reconciliationLoopFunc</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="comment">// 主要调谐方法，接下来重点分析</span></span><br><span class="line">       <span class="comment">// 按照顺序，对有需要的volume进行1) unmounted 2) attached/mounted 3) detached/unmounted</span></span><br><span class="line">      rc.reconcile()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> rc.populatorHasAddedPods() &amp;&amp; !rc.StatesHasBeenSynced() &#123;</span><br><span class="line">         glog.Infof(<span class="string">"Reconciler: start to sync state"</span>)</span><br><span class="line">         <span class="comment">// 通过遍历所有pods的volume目录，观察到当前节点上的真实情况，与dsw和asw做比较，已处理不一致的情况(kubelet重启时会遗留mounted volumes)</span></span><br><span class="line">         rc.sync()</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">reconcile</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 确保应该unmounted的volumes是unmounted的</span></span><br><span class="line">   <span class="keyword">for</span> _, mountedVolume := <span class="keyword">range</span> rc.actualStateOfWorld.GetMountedVolumes() &#123;</span><br><span class="line">      <span class="keyword">if</span> !rc.desiredStateOfWorld.PodExistsInVolume(mountedVolume.PodName, mountedVolume.VolumeName) &#123;</span><br><span class="line">         err := rc.operationExecutor.UnmountVolume(</span><br><span class="line">            mountedVolume.MountedVolume, rc.actualStateOfWorld, rc.kubeletPodsDir)</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 确保应该attached/mounted的volumes是attached的</span></span><br><span class="line">   <span class="keyword">for</span> _, volumeToMount := <span class="keyword">range</span> rc.desiredStateOfWorld.GetVolumesToMount() &#123;</span><br><span class="line">      volMounted, devicePath, err := rc.actualStateOfWorld.PodExistsInVolume(volumeToMount.PodName, volumeToMount.VolumeName)</span><br><span class="line">      volumeToMount.DevicePath = devicePath</span><br><span class="line">      <span class="keyword">if</span> cache.IsVolumeNotAttachedError(err) &#123;</span><br><span class="line">         <span class="keyword">if</span> rc.controllerAttachDetachEnabled || !volumeToMount.PluginIsAttachable &#123;</span><br><span class="line">            <span class="comment">// 如果controllerAttachDetachEnabled(即由controller-manager做attach操作)或volumePlugin不是attachable的，则等待volume被attach</span></span><br><span class="line">            err := rc.operationExecutor.VerifyControllerAttachedVolume(</span><br><span class="line">               volumeToMount.VolumeToMount,</span><br><span class="line">               rc.nodeName,</span><br><span class="line">               rc.actualStateOfWorld)</span><br><span class="line">            <span class="comment">// handle error</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 在kubelet内部对其attach</span></span><br><span class="line">            volumeToAttach := operationexecutor.VolumeToAttach&#123;</span><br><span class="line">               VolumeName: volumeToMount.VolumeName,</span><br><span class="line">               VolumeSpec: volumeToMount.VolumeSpec,</span><br><span class="line">               NodeName:   rc.nodeName,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            err := rc.operationExecutor.AttachVolume(volumeToAttach, rc.actualStateOfWorld)</span><br><span class="line">            <span class="comment">// handle error</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> !volMounted || cache.IsRemountRequiredError(err) &#123;</span><br><span class="line">         <span class="comment">// Volume is not mounted, or is already mounted, but requires remounting</span></span><br><span class="line">         remountingLogStr := <span class="string">""</span></span><br><span class="line">         isRemount := cache.IsRemountRequiredError(err)</span><br><span class="line">         err := rc.operationExecutor.MountVolume(</span><br><span class="line">            rc.waitForAttachTimeout,</span><br><span class="line">            volumeToMount.VolumeToMount,</span><br><span class="line">            rc.actualStateOfWorld,</span><br><span class="line">            isRemount)</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> cache.IsFSResizeRequiredError(err) &amp;&amp;</span><br><span class="line">         utilfeature.DefaultFeatureGate.Enabled(features.ExpandInUsePersistentVolumes) &#123;</span><br><span class="line">         glog.V(<span class="number">4</span>).Infof(volumeToMount.GenerateMsgDetailed(<span class="string">"Starting operationExecutor.ExpandVolumeFSWithoutUnmounting"</span>, <span class="string">""</span>))</span><br><span class="line">         err := rc.operationExecutor.ExpandVolumeFSWithoutUnmounting(</span><br><span class="line">            volumeToMount.VolumeToMount,</span><br><span class="line">            rc.actualStateOfWorld)</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 确保detached/unmounted的volume是detached/unmounted的</span></span><br><span class="line">   <span class="keyword">for</span> _, attachedVolume := <span class="keyword">range</span> rc.actualStateOfWorld.GetUnmountedVolumes() &#123;</span><br><span class="line">      <span class="keyword">if</span> !rc.desiredStateOfWorld.VolumeExists(attachedVolume.VolumeName) &amp;&amp;</span><br><span class="line">         !rc.operationExecutor.IsOperationPending(attachedVolume.VolumeName, nestedpendingoperations.EmptyUniquePodName) &#123;</span><br><span class="line">         <span class="keyword">if</span> attachedVolume.GloballyMounted &#123;</span><br><span class="line">            err := rc.operationExecutor.UnmountDevice(</span><br><span class="line">               attachedVolume.AttachedVolume, rc.actualStateOfWorld, rc.mounter)</span><br><span class="line">            <span class="comment">// handle error</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 由controller-manager进行detach或者不需要dettach</span></span><br><span class="line">            <span class="keyword">if</span> rc.controllerAttachDetachEnabled || !attachedVolume.PluginIsAttachable &#123;</span><br><span class="line">                <span class="comment">// 直接从asw.attachedVolumes中删除</span></span><br><span class="line">               rc.actualStateOfWorld.MarkVolumeAsDetached(attachedVolume.VolumeName, attachedVolume.NodeName)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 由kubelet内部进行detach</span></span><br><span class="line">               err := rc.operationExecutor.DetachVolume(</span><br><span class="line">                  attachedVolume.AttachedVolume, <span class="literal">false</span> <span class="comment">/* verifySafeToDetach */</span>, rc.actualStateOfWorld)</span><br><span class="line">               <span class="comment">// handle error</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">sync</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">defer</span> rc.updateLastSyncTime()</span><br><span class="line">   rc.syncStates()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">syncStates</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// 遍历podsDir获取真实的volume挂载情况</span></span><br><span class="line">   podVolumes, err := getVolumesFromPodDir(rc.kubeletPodsDir)</span><br><span class="line">   <span class="comment">// handle error</span></span><br><span class="line">   volumesNeedUpdate := <span class="built_in">make</span>(<span class="keyword">map</span>[v1.UniqueVolumeName]*reconstructedVolume)</span><br><span class="line">   volumeNeedReport := []v1.UniqueVolumeName&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> _, volume := <span class="keyword">range</span> podVolumes &#123;</span><br><span class="line">      <span class="keyword">if</span> rc.actualStateOfWorld.VolumeExistsWithSpecName(volume.podName, volume.volumeSpecName) &#123;</span><br><span class="line">         <span class="comment">// 与asw一致则不做任何处理</span></span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      volumeInDSW := rc.desiredStateOfWorld.VolumeExistsWithSpecName(volume.podName, volume.volumeSpecName)</span><br><span class="line">      <span class="comment">// 重建volume，调用rc.operationExecutor.ReconstructVolumeOperation</span></span><br><span class="line">      reconstructedVolume, err := rc.reconstructVolume(volume)</span><br><span class="line">      <span class="comment">// handle error</span></span><br><span class="line">      <span class="keyword">if</span> volumeInDSW &#123;</span><br><span class="line">         <span class="comment">// 如果在dsw中包含该volume，则需要将该volume上报为in use</span></span><br><span class="line">         volumeNeedReport = <span class="built_in">append</span>(volumeNeedReport, reconstructedVolume.volumeName)</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 更新volume</span></span><br><span class="line">      volumesNeedUpdate[reconstructedVolume.volumeName] = reconstructedVolume</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(volumesNeedUpdate) &gt; <span class="number">0</span> &#123;</span><br><span class="line">       <span class="comment">// 更新volumes状态。从node.Status.VolumesAttached中获取devicePath，并调用actualStateOfWorld.MarkVolumeAsAttached/actualStateOfWorld.MarkVolumeAsMounted/actualStateOfWorld.MarkDeviceAsMounted</span></span><br><span class="line">      <span class="keyword">if</span> err = rc.updateStates(volumesNeedUpdate); err != <span class="literal">nil</span> &#123;</span><br><span class="line">         glog.Errorf(<span class="string">"Error occurred during reconstruct volume from disk: %v"</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(volumeNeedReport) &gt; <span class="number">0</span> &#123;</span><br><span class="line">       <span class="comment">// 将volume标记为in use</span></span><br><span class="line">      rc.desiredStateOfWorld.MarkVolumesReportedInUse(volumeNeedReport)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. reconcile进行如下调谐</span><br><span class="line">a) 对asw中存在但dsw中不存在的volume，调用operationExecutor.UnmountVolume</span><br><span class="line">b) 对dsw中存在的volume，如果asw表明该volume未attach则调用operationExecutor.AttachVolume，</span><br><span class="line">    如果asw表明该volume为unmounted或者remountRequired则调用operationExecutor.MountVolume，</span><br><span class="line">    如果asw表明该volume为resizeRequired则调用operationExecutor.ExpandVolumeFSWithoutUnmounting</span><br><span class="line">c) 对asw中的unmountedVolumes(即没有pod使用的volume)进行清理，调用operationExecutor.UnmountDevice或MarkVolumeAsDetached或operationExecutor.DetachVolume</span><br><span class="line"></span><br><span class="line">2. sync进行如下调谐</span><br><span class="line">a) 如果真实的mount信息与asw不符，则调用operationExecutor.ReconstructVolumeOperation根据遍历podsDir得到的信息对podVolume进行重建</span><br><span class="line">b) 将确实的volume信息加入到asw中，并标记dsw中相应的volume为in use</span><br></pre></td></tr></table></figure>

<h2 id="operationExecutor"><a href="#operationExecutor" class="headerlink" title="operationExecutor"></a>operationExecutor</h2><p>只记下最为关键的MountVolume操作</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(oe *operationExecutor)</span> <span class="title">MountVolume</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   waitForAttachTimeout time.Duration,</span></span></span><br><span class="line"><span class="function"><span class="params">   volumeToMount VolumeToMount,</span></span></span><br><span class="line"><span class="function"><span class="params">   actualStateOfWorld ActualStateOfWorldMounterUpdater,</span></span></span><br><span class="line"><span class="function"><span class="params">   isRemount <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">   <span class="keyword">if</span> fsVolume &#123;</span><br><span class="line">      <span class="comment">// filesystem情况</span></span><br><span class="line">      generatedOperations, err = oe.operationGenerator.GenerateMountVolumeFunc(</span><br><span class="line">         waitForAttachTimeout, volumeToMount, actualStateOfWorld, isRemount)</span><br><span class="line"></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 块设备情况</span></span><br><span class="line">      generatedOperations, err = oe.operationGenerator.GenerateMapVolumeFunc(</span><br><span class="line">         waitForAttachTimeout, volumeToMount, actualStateOfWorld)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 执行mount</span></span><br><span class="line">   <span class="keyword">return</span> oe.pendingOperations.Run(</span><br><span class="line">      volumeToMount.VolumeName, podName, generatedOperations)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(og *operationGenerator)</span> <span class="title">GenerateMountVolumeFunc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   waitForAttachTimeout time.Duration,</span></span></span><br><span class="line"><span class="function"><span class="params">   volumeToMount VolumeToMount,</span></span></span><br><span class="line"><span class="function"><span class="params">   actualStateOfWorld ActualStateOfWorldMounterUpdater,</span></span></span><br><span class="line"><span class="function"><span class="params">   isRemount <span class="keyword">bool</span>)</span> <span class="params">(volumetypes.GeneratedOperations, error)</span></span> &#123;</span><br><span class="line">   <span class="comment">// Get mounter plugin</span></span><br><span class="line">   volumePlugin, err :=</span><br><span class="line">      og.volumePluginMgr.FindPluginBySpec(volumeToMount.VolumeSpec)</span><br><span class="line">   <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 检查nodeAffinity是否匹配</span></span><br><span class="line">   affinityErr := checkNodeAffinity(og, volumeToMount, volumePlugin)</span><br><span class="line">   <span class="comment">// handle error</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 调用volume插件的NewMounter生成具体的mounter工具</span></span><br><span class="line">   volumeMounter, newMounterErr := volumePlugin.NewMounter(</span><br><span class="line">      volumeToMount.VolumeSpec,</span><br><span class="line">      volumeToMount.Pod,</span><br><span class="line">      volume.VolumeOptions&#123;&#125;)</span><br><span class="line">   <span class="comment">// handle error</span></span><br><span class="line">   <span class="comment">// 检查mount配置项是否支持</span></span><br><span class="line">   mountCheckError := checkMountOptionSupport(og, volumeToMount, volumePlugin)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// handl error</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 获取attacher</span></span><br><span class="line">   attachableVolumePlugin, _ :=</span><br><span class="line">      og.volumePluginMgr.FindAttachablePluginBySpec(volumeToMount.VolumeSpec)</span><br><span class="line">   <span class="keyword">var</span> volumeAttacher volume.Attacher</span><br><span class="line">   <span class="keyword">if</span> attachableVolumePlugin != <span class="literal">nil</span> &#123;</span><br><span class="line">      volumeAttacher, _ = attachableVolumePlugin.NewAttacher()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 挂载路径用户组</span></span><br><span class="line">   <span class="keyword">var</span> fsGroup *<span class="keyword">int64</span></span><br><span class="line">   <span class="keyword">if</span> volumeToMount.Pod.Spec.SecurityContext != <span class="literal">nil</span> &amp;&amp;</span><br><span class="line">      volumeToMount.Pod.Spec.SecurityContext.FSGroup != <span class="literal">nil</span> &#123;</span><br><span class="line">      fsGroup = volumeToMount.Pod.Spec.SecurityContext.FSGroup</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 具体的挂载方法</span></span><br><span class="line">   mountVolumeFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(error, error)</span></span> &#123;</span><br><span class="line">      <span class="keyword">if</span> volumeAttacher != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="comment">// 调用volumeAttacher，等待volume被attach</span></span><br><span class="line">         <span class="comment">// 对于csi来说，controller-manager的attachDetachController会调用csi的attacher生成volumeAttachment和更新ode.Status.VolumesAttached状态，然后由external-attacher进行attach操作并修改volumeAttachment</span></span><br><span class="line">         <span class="comment">// 之后由kubelet在此处等待attach（即监听volumeAttachment）。v1.11版本中此处存在bug，某些情况下kubelet会尝试获取错误的volumeAttachment，是由于其将node.Status.VolumesAttached中的devicePath作为volumeAttachment名了</span></span><br><span class="line">         devicePath, err := volumeAttacher.WaitForAttach(</span><br><span class="line">            volumeToMount.VolumeSpec, volumeToMount.DevicePath, volumeToMount.Pod, waitForAttachTimeout)</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// 将</span></span><br><span class="line">         deviceMountPath, err :=</span><br><span class="line">            volumeAttacher.GetDeviceMountPath(volumeToMount.VolumeSpec)</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Mount device to global mount path</span></span><br><span class="line">         err = volumeAttacher.MountDevice(</span><br><span class="line">            volumeToMount.VolumeSpec,</span><br><span class="line">            devicePath,</span><br><span class="line">            deviceMountPath)</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// 记录device已mount</span></span><br><span class="line">         markDeviceMountedErr := actualStateOfWorld.MarkDeviceAsMounted(</span><br><span class="line">            volumeToMount.VolumeName, devicePath, deviceMountPath)</span><br><span class="line">            <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// resize挂载卷</span></span><br><span class="line">         resizeSimpleError, resizeDetailedError := og.resizeFileSystem(volumeToMount, devicePath, deviceMountPath, volumePlugin.GetPluginName())</span><br><span class="line">         <span class="comment">// handle error</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> og.checkNodeCapabilitiesBeforeMount &#123;</span><br><span class="line">         <span class="comment">// 检查是否可以mount</span></span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 执行mount操作</span></span><br><span class="line">      mountErr := volumeMounter.SetUp(fsGroup)</span><br><span class="line">      <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新asw</span></span><br><span class="line">      markVolMountedErr := actualStateOfWorld.MarkVolumeAsMounted(</span><br><span class="line">         volumeToMount.PodName,</span><br><span class="line">         volumeToMount.Pod.UID,</span><br><span class="line">         volumeToMount.VolumeName,</span><br><span class="line">         volumeMounter,</span><br><span class="line">         <span class="literal">nil</span>,</span><br><span class="line">         volumeToMount.OuterVolumeSpecName,</span><br><span class="line">         volumeToMount.VolumeGidValue,</span><br><span class="line">         volumeToMount.VolumeSpec)</span><br><span class="line">      <span class="comment">// handle error</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   eventRecorderFunc := <span class="comment">// event记录方法</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> volumetypes.GeneratedOperations&#123;</span><br><span class="line">      OperationFunc:     mountVolumeFunc,</span><br><span class="line">      EventRecorderFunc: eventRecorderFunc,</span><br><span class="line">      CompleteFunc:      util.OperationCompleteHook(volumePlugin.GetPluginName(), <span class="string">"volume_mount"</span>),</span><br><span class="line">   &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">锋寒</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.pangsq.cn/2020/07/26/volume-manager/">https://blog.pangsq.cn/2020/07/26/volume-manager/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.pangsq.cn">锋寒的博客</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/Kubelet/">Kubelet</a><a class="post-meta__tags" href="/tags/Volume/">Volume</a><a class="post-meta__tags" href="/tags/Source/">Source</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/08/08/istio-xds/index/"><i class="fa fa-chevron-left">  </i><span>从xDS开始读懂istio的实现</span></a></div><div class="next-post pull-right"><a href="/2020/05/07/controller-ReplicaSet-Replication/"><span>Kubernetes Controller —— ReplicaSet 和 Replication</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By 锋寒</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>